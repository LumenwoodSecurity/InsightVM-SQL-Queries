WITH cert_expiration_dates AS (
   SELECT
      DISTINCT asset_id,
      service_id,
      name,
      value
   FROM
      dim_asset_service_configuration
   WHERE
      lower(name) LIKE '%ssl.cert.not.valid.after'
),
vulnerability_data AS (
   SELECT
      asset_id,
      count(vulnerability_id) AS num_vulnerabilities
   FROM
      fact_asset_vulnerability_instance
   GROUP BY
      asset_id
)

SELECT
    dt.tag_name AS "Tag Name",
    dt.tag_type AS "Tag Type",
    cast(sum(fa.riskscore) AS BIGINT) AS "Risk Score",
    count(fa.asset_id) AS "Total Assets",
    sum(case when CURRENT_TIMESTAMP - cast(ced.value AS DATE) > INTERVAL '90 days' then 1 else 0 end) AS "Assets with Expired SSL Certificates",
    coalesce(sum(vd.num_vulnerabilities), 0) AS "Total Vulnerabilities",
    coalesce(avg(vd.num_vulnerabilities), 0) AS "Average Vulnerabilities per Asset"
FROM
    dim_tag dt
    JOIN dim_tag_asset dta USING(tag_id)
    JOIN fact_asset fa USING(asset_id)
    LEFT JOIN cert_expiration_dates ced ON fa.asset_id = ced.asset_id
    LEFT JOIN vulnerability_data vd ON fa.asset_id = vd.asset_id
WHERE
    dt.tag_type = 'owner'
GROUP BY
    dt.tag_name,
    dt.tag_type
ORDER BY
    "Risk Score" DESC
------------------------------------------------------------------------------------
WITH cert_expiration_dates AS (
   SELECT
      DISTINCT asset_id,
      service_id,
      name,
      value
   FROM
      dim_asset_service_configuration
   WHERE
      lower(name) LIKE '%ssl.cert.not.valid.after'
),
vulnerability_counts AS (
   SELECT
      asset_id,
      COUNT(*) AS total_vulnerabilities,
      COUNT(DISTINCT CASE WHEN vulnerability_instances.exploitable = TRUE THEN vulnerability_id END) AS vulnerabilities_with_exploits
   FROM
      fact_asset_vulnerability_instance
   GROUP BY
      asset_id
)
SELECT
   da.ip_address,
   da.host_name,
   da.mac_address,
   date(ced.value) AS cert_expiry_date,
   dt.tag_name,
   COUNT(DISTINCT dt.tag_name) OVER (PARTITION BY da.asset_id) AS num_tags,
   COUNT(DISTINCT da.asset_id) OVER (PARTITION BY dt.tag_name) AS num_assets,
   vc.total_vulnerabilities,
   vc.vulnerabilities_with_exploits
FROM
   dim_asset da
   JOIN cert_expiration_dates AS ced USING (asset_id)
   JOIN dim_tag_asset dta ON da.asset_id = dta.asset_id
   JOIN dim_tag dt ON dta.tag_id = dt.tag_id
   JOIN vulnerability_counts vc ON da.asset_id = vc.asset_id
WHERE
   CURRENT_TIMESTAMP - cast(ced.value AS DATE) <= INTERVAL '90 days'
ORDER BY
   date
